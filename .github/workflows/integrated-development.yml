name: çµ±åˆé–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

on:
  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆãƒ»æ›´æ–°æ™‚
  pull_request:
    types: [opened, synchronize, reopened]
  
  # Issuesä½œæˆãƒ»ã‚³ãƒ¡ãƒ³ãƒˆæ™‚
  issues:
    types: [opened, assigned]
  
  # ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆæ™‚ï¼ˆPRã€Issueä¸¡æ–¹ï¼‰
  issue_comment:
    types: [created]
  
  # PRãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆæ™‚
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  pages: write
  id-token: write

jobs:
  # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
  code-quality:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: åŸºæœ¬çš„ãªã‚³ãƒ¼ãƒ‰æ¤œè¨¼
        run: |
          echo "=== ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯é–‹å§‹ ==="
          # HTMLãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
          if command -v html5validator &> /dev/null; then
            html5validator --root . --ignore-re ".*three\.min\.js.*"
          fi
          
          # JavaScriptã®åŸºæœ¬ãƒã‚§ãƒƒã‚¯
          find js/ -name "*.js" -exec node -c {} \; 2>&1 | tee syntax-check.log || true
          
          # ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ãƒã‚§ãƒƒã‚¯
          echo "=== ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ç¢ºèª ==="
          ls -la
          echo "=== JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª ==="
          find js/ -name "*.js" -ls
          
      - name: Three.js ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
        run: |
          echo "=== Three.jsè¨­å®šç¢ºèª ==="
          if [ -f "three.min.js" ]; then
            echo "âœ… Three.js ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨"
            head -n 5 three.min.js | grep -o "r[0-9]\+" || echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãªã—"
          else
            echo "âŒ Three.js ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãªã—"
          fi

  # Claude Code Action
  claude-assistant:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, 'claude')))
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Claudeã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆå®Ÿè¡Œ
        uses: anthropics/claude-code-action@main
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          timeout_minutes: "60"
        env:
          # è¿½åŠ ã®ç’°å¢ƒè¨­å®š
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯
        run: |
          echo "=== ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯ ==="
          # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          required_files=("index.html" "manifest.json" "sw.js" "three.min.js")
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file å­˜åœ¨"
            else
              echo "âŒ $file ä¸è¶³"
              exit 1
            fi
          done
          
          # JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
          echo "=== JavaScriptæ§‹æ–‡ãƒã‚§ãƒƒã‚¯ ==="
          find js/ -name "*.js" -exec node -c {} \;

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ® MindTravel3D æ›´æ–°å®Œäº†ï¼"

  # é–‹ç™ºçŠ¶æ³ãƒ¬ãƒãƒ¼ãƒˆ
  development-report:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: é–‹ç™ºçŠ¶æ³åˆ†æ
        run: |
          echo "=== MindTravel3D é–‹ç™ºçŠ¶æ³ãƒ¬ãƒãƒ¼ãƒˆ ===" > report.md
          echo "" >> report.md
          echo "## ğŸ“Š ã‚³ãƒ¼ãƒ‰çµ±è¨ˆ" >> report.md
          echo "- JavaScriptãƒ•ã‚¡ã‚¤ãƒ«æ•°: $(find js/ -name "*.js" | wc -l)" >> report.md
          echo "- ç·è¡Œæ•°: $(find js/ -name "*.js" -exec wc -l {} + | tail -1 | awk '{print $1}')" >> report.md
          echo "- HTMLãƒ•ã‚¡ã‚¤ãƒ«: $(find . -name "*.html" | wc -l)" >> report.md
          echo "" >> report.md
          echo "## ğŸ¯ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›®æ¨™" >> report.md
          echo "- ç›®æ¨™ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: 1,000ä¸‡äºº" >> report.md
          echo "- ç¾åœ¨ãƒ•ã‚§ãƒ¼ã‚º: MVP â†’ 1stãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ100ä¸‡ãƒ¦ãƒ¼ã‚¶ãƒ¼ç›®æ¨™ï¼‰" >> report.md
          echo "" >> report.md
          echo "## ğŸ”§ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ç¢ºèª" >> report.md
          if [ -f "three.min.js" ]; then
            echo "- âœ… Three.js (ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«)" >> report.md
          fi
          if [ -f "manifest.json" ]; then
            echo "- âœ… PWAå¯¾å¿œ" >> report.md
          fi
          echo "- âœ… ãƒãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å¯¾å¿œ" >> report.md
          
          cat report.md
          
      - name: ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });